<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StudyFlow ‚Äì Prototipo MVP (autocontenido)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#e8ecff;
      --muted:#a7b0d6;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.08);
      --shadow: 0 20px 50px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(110,231,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(167,139,250,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    header{
      padding:22px 18px 10px;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));
      box-shadow: 0 10px 25px rgba(110,231,255,.12), 0 10px 25px rgba(167,139,250,.10);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.5), transparent 55%);
      transform: rotate(25deg);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
    }
    .top-actions{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border-color;
      font-weight:600;
      font-size:13px;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.06); border-color:rgba(255,255,255,.14);}
    .btn.primary{
      border-color: rgba(110,231,255,.28);
      background: linear-gradient(135deg, rgba(110,231,255,.18), rgba(167,139,250,.14));
    }
    .btn.danger{border-color:rgba(251,113,133,.28); background: rgba(251,113,133,.08);}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .dot{width:8px; height:8px; border-radius:999px; background: var(--good);}
    main{
      max-width:1200px;
      margin:0 auto;
      padding:12px 18px 34px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr;}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .card .head h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card .head small{
      color:var(--muted);
      font-size:12px;
    }
    .card .body{padding:14px;}
    .grid{
      display:grid;
      gap:10px;
    }
    .grid.cols2{grid-template-columns: 1fr 1fr;}
    @media (max-width: 640px){
      .grid.cols2{grid-template-columns:1fr;}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:74px; resize:vertical;}
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .seg button{
      border:0; background:transparent; color:var(--muted);
      padding:8px 10px; cursor:pointer; font-weight:700; font-size:12px;
    }
    .seg button.active{
      color:var(--text);
      background: rgba(110,231,255,.12);
    }

    /* Lista tareas */
    .taskbar{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .search{
      flex:1;
      min-width:180px;
    }
    .tasklist{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .task{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 10px;
      display:grid;
      grid-template-columns: 22px 1fr auto;
      gap:10px;
      align-items:start;
      transition:.15s transform, .15s border-color, .15s background;
    }
    .task:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.14); background: rgba(0,0,0,.22);}
    .chk{
      width:18px; height:18px; border-radius:6px;
      border:1px solid rgba(255,255,255,.16);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
      margin-top:2px;
      background: rgba(255,255,255,.04);
    }
    .chk.done{background: rgba(52,211,153,.18); border-color: rgba(52,211,153,.32);}
    .chk svg{display:none}
    .chk.done svg{display:block}
    .t-title{
      font-weight:800;
      font-size:14px;
      line-height:1.25;
      margin:0;
    }
    .t-title.done{color:rgba(232,236,255,.65); text-decoration: line-through;}
    .t-meta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      color:var(--muted);
      font-size:12px;
      align-items:center;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-weight:700;
      color:rgba(232,236,255,.8);
    }
    .prio{
      padding:4px 8px;
      border-radius:999px;
      font-weight:800;
      border:1px solid var(--line);
    }
    .p-low{color: rgba(110,231,255,.95); border-color:rgba(110,231,255,.22); background:rgba(110,231,255,.06);}
    .p-mid{color: rgba(251,191,36,.95); border-color:rgba(251,191,36,.22); background:rgba(251,191,36,.06);}
    .p-high{color: rgba(251,113,133,.95); border-color:rgba(251,113,133,.22); background:rgba(251,113,133,.06);}
    .t-actions{
      display:flex; gap:6px; align-items:center;
    }
    .iconbtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:.15s transform, .15s background, .15s border-color;
    }
    .iconbtn:hover{transform:translateY(-1px); background: rgba(255,255,255,.06); border-color:rgba(255,255,255,.14);}
    .small{font-size:12px; color:var(--muted);}

    /* Semana */
    .week{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    @media (max-width: 980px){
      .week{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width: 520px){
      .week{grid-template-columns: 1fr;}
    }
    .day{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      min-height:120px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .day h3{
      margin:0;
      font-size:12px;
      letter-spacing:.4px;
      color:rgba(232,236,255,.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .day h3 span{color:var(--muted); font-weight:700;}
    .mini{
      display:flex; flex-direction:column; gap:6px;
    }
    .mini-item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:12px;
      padding:8px;
      font-size:12px;
      line-height:1.25;
      display:flex;
      gap:8px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .mini-item b{font-weight:800}
    .mini-item .due{color:var(--muted); font-weight:700; font-size:11px;}

    /* Estad√≠sticas */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .kpis{grid-template-columns: 1fr;}
    }
    .kpi{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
    }
    .kpi .v{font-size:22px; font-weight:900; margin:2px 0 0;}
    .kpi .l{font-size:12px; color:var(--muted);}
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      margin-top:10px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(110,231,255,.9), rgba(167,139,250,.9));
      transition: width .25s ease;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background: rgba(10,14,30,.92);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      color:rgba(232,236,255,.92);
      font-size:13px;
      display:none;
      max-width:92vw;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(720px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(0,0,0,.12);
    }
    .modal .mhead b{font-size:13px}
    .modal .mbody{padding:14px;}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      white-space:pre;
      overflow:auto;
      max-height: 52vh;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>StudyFlow <span style="color:var(--muted);font-weight:800;">¬∑ MVP</span></h1>
      <p>Prototipo autocontenido: tareas, semana, recordatorios y estad√≠sticas</p>
    </div>
  </div>
  <div class="top-actions">
    <span class="pill" title="Estado del prototipo">
      <span class="dot" id="syncDot"></span>
      <span id="statusText">Listo (guardado local)</span>
    </span>
    <button class="btn" id="btnNotifs">üîî Recordatorios</button>
    <button class="btn" id="btnExport">Exportar</button>
    <button class="btn" id="btnImport">Importar</button>
    <button class="btn danger" id="btnReset">Reiniciar</button>
  </div>
</header>

<main>
  <!-- Columna izquierda: crear + lista -->
  <section class="card">
    <div class="head">
      <h2>Captura r√°pida</h2>
      <small>Crear tareas en 20 segundos</small>
    </div>
    <div class="body">
      <div class="grid cols2">
        <div>
          <label for="title">Tarea</label>
          <input id="title" placeholder="Ej.: Estudiar tema 3 ¬∑ Econom√≠a" />
        </div>
        <div>
          <label for="due">Fecha</label>
          <input id="due" type="date" />
        </div>

        <div>
          <label for="time">Hora (opcional)</label>
          <input id="time" type="time" />
        </div>
        <div>
          <label for="prio">Prioridad</label>
          <select id="prio">
            <option value="low">Baja</option>
            <option value="mid" selected>Media</option>
            <option value="high">Alta</option>
          </select>
        </div>

        <div>
          <label for="tags">Etiquetas (separadas por coma)</label>
          <input id="tags" placeholder="Ej.: mates, repaso, examen" />
        </div>
        <div>
          <label for="rem">Recordatorio</label>
          <select id="rem">
            <option value="none" selected>Sin recordatorio</option>
            <option value="at">A la hora indicada</option>
            <option value="15">15 min antes</option>
            <option value="60">1 hora antes</option>
            <option value="1440">1 d√≠a antes</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label for="notes">Notas (opcional)</label>
        <textarea id="notes" placeholder="Ej.: Priorizar ejercicios 4‚Äì7. Revisar apuntes y hacer test."></textarea>
      </div>

      <div class="row" style="margin-top:10px; justify-content:space-between;">
        <div class="small" id="hint">Consejo: usa fecha + hora para probar recordatorios.</div>
        <button class="btn primary" id="btnAdd">A√±adir tarea</button>
      </div>

      <hr style="border:0;border-top:1px solid var(--line);margin:14px 0 12px;" />

      <div class="taskbar">
        <input class="search" id="q" placeholder="Buscar (t√≠tulo/etiquetas/notas)..." />
        <div class="seg" aria-label="Filtros">
          <button class="active" data-filter="all">Todas</button>
          <button data-filter="open">Pendientes</button>
          <button data-filter="done">Hechas</button>
          <button data-filter="today">Hoy</button>
        </div>
        <select id="sort" style="width:170px;">
          <option value="dueAsc" selected>Orden: fecha ‚Üë</option>
          <option value="dueDesc">Orden: fecha ‚Üì</option>
          <option value="prioDesc">Orden: prioridad</option>
          <option value="createdDesc">Orden: recientes</option>
        </select>
      </div>

      <div class="tasklist" id="tasklist"></div>
      <div class="small" id="empty" style="margin-top:10px; display:none;">No hay tareas con este filtro.</div>
    </div>
  </section>

  <!-- Columna derecha: semana + stats -->
  <section class="card">
    <div class="head">
      <h2>Semana y m√©tricas</h2>
      <small>Plan semanal + progreso</small>
    </div>
    <div class="body">
      <div class="kpis">
        <div class="kpi">
          <div class="l">Pendientes</div>
          <div class="v" id="kOpen">0</div>
          <div class="bar"><div id="barOpen"></div></div>
        </div>
        <div class="kpi">
          <div class="l">Completadas</div>
          <div class="v" id="kDone">0</div>
          <div class="bar"><div id="barDone"></div></div>
        </div>
        <div class="kpi">
          <div class="l">Racha (d√≠as con tareas hechas)</div>
          <div class="v" id="kStreak">0</div>
          <div class="small" id="streakHint" style="margin-top:8px;">Marca al menos 1 tarea al d√≠a.</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--line);margin:14px 0 12px;" />

      <div class="row" style="justify-content:space-between;">
        <div>
          <b style="font-size:13px;">Plan semanal</b>
          <div class="small">Tareas por d√≠a (seg√∫n fecha asignada)</div>
        </div>
        <div class="row">
          <button class="btn" id="btnThisWeek">Esta semana</button>
          <button class="btn" id="btnNextWeek">+7 d√≠as</button>
        </div>
      </div>

      <div style="height:10px;"></div>
      <div class="week" id="week"></div>

      <hr style="border:0;border-top:1px solid var(--line);margin:14px 0 12px;" />

      <div class="small">
        üíæ Todo se guarda en tu navegador (localStorage). Exporta si quieres llevarlo a otro equipo.
      </div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<!-- Modal export/import -->
<div class="modal-backdrop" id="modal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="mhead">
      <b id="mTitle">Datos</b>
      <button class="btn" id="btnClose">Cerrar</button>
    </div>
    <div class="mbody">
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <div class="small" id="mHelp">Exporta o pega JSON para importar.</div>
        <div class="row">
          <button class="btn" id="btnCopy">Copiar</button>
          <button class="btn primary" id="btnApply">Aplicar importaci√≥n</button>
        </div>
      </div>
      <textarea id="io" style="min-height:220px; border-radius:14px;"></textarea>
      <div class="small" style="margin-top:8px;">
        Nota: la importaci√≥n sustituye todas las tareas actuales.
      </div>
    </div>
  </div>
</div>

<script>
/* ============================
   StudyFlow MVP (autocontenido)
   - Tareas con fecha/hora
   - Recordatorios (notificaciones o alertas)
   - Semana (vista agrupada)
   - Estad√≠sticas + racha
   - Export/Import JSON
   ============================ */

(() => {
  const LS_KEY = "studyflow_mvp_v1";
  const LS_DONE_DAYS = "studyflow_done_days_v1";
  const state = {
    tasks: [],
    filter: "all",
    weekStart: startOfWeek(new Date()),
    notifsEnabled: false,
    timers: new Map(), // id -> timeout
  };

  // ----- Helpers fecha -----
  function pad(n){ return String(n).padStart(2,"0"); }
  function ymd(d){
    const dt = new Date(d);
    return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate());
  }
  function hm(d){
    const dt = new Date(d);
    return pad(dt.getHours())+":"+pad(dt.getMinutes());
  }
  function parseDateTime(dateStr, timeStr){
    if(!dateStr) return null;
    const t = timeStr && timeStr.trim() ? timeStr.trim() : "09:00";
    const [Y,M,D] = dateStr.split("-").map(Number);
    const [h,m] = t.split(":").map(Number);
    return new Date(Y, M-1, D, h||0, m||0, 0, 0);
  }
  function startOfWeek(d){
    const dt = new Date(d);
    dt.setHours(0,0,0,0);
    const day = (dt.getDay() + 6) % 7; // lunes=0
    dt.setDate(dt.getDate() - day);
    return dt;
  }
  function addDays(d, n){
    const dt = new Date(d);
    dt.setDate(dt.getDate()+n);
    return dt;
  }
  function isSameDay(a,b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function today0(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  }

  // ----- UI refs -----
  const $ = (id) => document.getElementById(id);
  const tasklist = $("tasklist");
  const empty = $("empty");
  const q = $("q");
  const sortSel = $("sort");
  const segBtns = [...document.querySelectorAll(".seg button")];

  // Capture form
  const titleI = $("title");
  const dueI = $("due");
  const timeI = $("time");
  const prioI = $("prio");
  const tagsI = $("tags");
  const notesI = $("notes");
  const remI = $("rem");

  // Stats
  const kOpen = $("kOpen");
  const kDone = $("kDone");
  const kStreak = $("kStreak");
  const barOpen = $("barOpen");
  const barDone = $("barDone");

  // Week
  const weekEl = $("week");
  const btnThisWeek = $("btnThisWeek");
  const btnNextWeek = $("btnNextWeek");

  // Top actions
  const btnAdd = $("btnAdd");
  const btnReset = $("btnReset");
  const btnExport = $("btnExport");
  const btnImport = $("btnImport");
  const btnNotifs = $("btnNotifs");
  const statusText = $("statusText");
  const syncDot = $("syncDot");

  // Modal
  const modal = $("modal");
  const io = $("io");
  const btnClose = $("btnClose");
  const btnCopy = $("btnCopy");
  const btnApply = $("btnApply");
  const mTitle = $("mTitle");
  const mHelp = $("mHelp");

  // Toast
  const toast = $("toast");
  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.style.display="none", 2400);
  }

  // ----- Persistencia -----
  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(state.tasks));
    statusPulse("Guardado");
    rescheduleAll();
  }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      state.tasks = raw ? JSON.parse(raw) : [];
      // sanea
      state.tasks = state.tasks.map(t => ({
        id: t.id || cryptoId(),
        title: String(t.title || "").trim(),
        dueDate: t.dueDate || "",
        dueTime: t.dueTime || "",
        prio: t.prio || "mid",
        tags: Array.isArray(t.tags) ? t.tags : parseTags(t.tags || ""),
        notes: t.notes || "",
        reminder: t.reminder || "none",
        done: !!t.done,
        createdAt: t.createdAt || Date.now(),
        doneAt: t.doneAt || null
      }));
    }catch(e){
      state.tasks = [];
    }
  }

  function cryptoId(){
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : "t_"+Math.random().toString(36).slice(2);
  }
  function parseTags(s){
    if(!s) return [];
    return String(s).split(",").map(x=>x.trim()).filter(Boolean).slice(0,8);
  }

  // ----- Estado UI -----
  function statusPulse(txt){
    statusText.textContent = txt + " (local)";
    syncDot.style.background = "var(--good)";
    syncDot.style.boxShadow = "0 0 0 6px rgba(52,211,153,.08)";
    clearTimeout(statusPulse._t);
    statusPulse._t = setTimeout(()=>{
      syncDot.style.boxShadow = "none";
      statusText.textContent = "Listo (guardado local)";
    }, 900);
  }

  // ----- CRUD tareas -----
  function addTask(){
    const title = titleI.value.trim();
    if(!title){
      showToast("Escribe un t√≠tulo de tarea.");
      titleI.focus();
      return;
    }
    const dueDate = dueI.value;
    const dueTime = timeI.value;
    const prio = prioI.value;
    const tags = parseTags(tagsI.value);
    const notes = notesI.value.trim();
    const reminder = remI.value;

    const t = {
      id: cryptoId(),
      title, dueDate, dueTime, prio, tags, notes,
      reminder,
      done:false,
      createdAt: Date.now(),
      doneAt: null
    };
    state.tasks.push(t);
    save();
    render();
    showToast("Tarea a√±adida.");
    // reset parcial
    titleI.value = "";
    notesI.value = "";
    tagsI.value = "";
    remI.value = "none";
    titleI.focus();
  }

  function toggleDone(id){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;
    t.done = !t.done;
    t.doneAt = t.done ? Date.now() : null;
    save();
    render();
    if(t.done) registerDoneDay(new Date());
  }

  function removeTask(id){
    const idx = state.tasks.findIndex(x=>x.id===id);
    if(idx<0) return;
    state.tasks.splice(idx,1);
    save();
    render();
    showToast("Tarea eliminada.");
  }

  function editTask(id){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;

    // Carga en formulario para edici√≥n r√°pida
    titleI.value = t.title;
    dueI.value = t.dueDate || "";
    timeI.value = t.dueTime || "";
    prioI.value = t.prio || "mid";
    tagsI.value = (t.tags||[]).join(", ");
    notesI.value = t.notes || "";
    remI.value = t.reminder || "none";

    // Sustituye bot√≥n "A√±adir" por "Guardar cambios"
    btnAdd.textContent = "Guardar cambios";
    btnAdd.classList.add("primary");
    btnAdd.onclick = () => {
      const newTitle = titleI.value.trim();
      if(!newTitle){
        showToast("El t√≠tulo no puede estar vac√≠o.");
        return;
      }
      t.title = newTitle;
      t.dueDate = dueI.value;
      t.dueTime = timeI.value;
      t.prio = prioI.value;
      t.tags = parseTags(tagsI.value);
      t.notes = notesI.value.trim();
      t.reminder = remI.value;

      save();
      render();
      showToast("Cambios guardados.");

      // reset UI
      btnAdd.textContent = "A√±adir tarea";
      btnAdd.classList.add("primary");
      btnAdd.onclick = addTask;
      titleI.value = ""; notesI.value = ""; tagsI.value = ""; remI.value = "none";
      dueI.value = ""; timeI.value = "";
    };

    showToast("Editando: guarda cambios arriba.");
    titleI.focus();
  }

  // ----- Filtros y orden -----
  function priorityRank(p){
    return p==="high" ? 3 : p==="mid" ? 2 : 1;
  }

  function filteredTasks(){
    const text = q.value.trim().toLowerCase();
    const now = new Date();
    const today = today0();

    let arr = state.tasks.slice();

    // filtro segmentado
    if(state.filter==="open") arr = arr.filter(t=>!t.done);
    if(state.filter==="done") arr = arr.filter(t=>t.done);
    if(state.filter==="today"){
      arr = arr.filter(t=>{
        if(!t.dueDate) return false;
        const d = parseDateTime(t.dueDate, t.dueTime || "00:00");
        return d && isSameDay(d, today);
      });
    }

    // b√∫squeda
    if(text){
      arr = arr.filter(t=>{
        const hay = [
          t.title,
          (t.tags||[]).join(" "),
          t.notes||"",
          t.dueDate||"",
          t.dueTime||""
        ].join(" ").toLowerCase();
        return hay.includes(text);
      });
    }

    // orden
    const s = sortSel.value;
    arr.sort((a,b)=>{
      if(s==="dueAsc"){
        const ad = a.dueDate ? parseDateTime(a.dueDate, a.dueTime) : null;
        const bd = b.dueDate ? parseDateTime(b.dueDate, b.dueTime) : null;
        const av = ad ? ad.getTime() : Number.POSITIVE_INFINITY;
        const bv = bd ? bd.getTime() : Number.POSITIVE_INFINITY;
        if(av!==bv) return av-bv;
        return b.createdAt - a.createdAt;
      }
      if(s==="dueDesc"){
        const ad = a.dueDate ? parseDateTime(a.dueDate, a.dueTime) : null;
        const bd = b.dueDate ? parseDateTime(b.dueDate, b.dueTime) : null;
        const av = ad ? ad.getTime() : Number.NEGATIVE_INFINITY;
        const bv = bd ? bd.getTime() : Number.NEGATIVE_INFINITY;
        if(av!==bv) return bv-av;
        return b.createdAt - a.createdAt;
      }
      if(s==="prioDesc"){
        const ap = priorityRank(a.prio);
        const bp = priorityRank(b.prio);
        if(ap!==bp) return bp-ap;
        return (a.dueDate||"").localeCompare(b.dueDate||"");
      }
      if(s==="createdDesc"){
        return b.createdAt - a.createdAt;
      }
      return 0;
    });

    return arr;
  }

  // ----- Render tareas -----
  function prioBadge(p){
    if(p==="high") return `<span class="prio p-high">Alta</span>`;
    if(p==="low") return `<span class="prio p-low">Baja</span>`;
    return `<span class="prio p-mid">Media</span>`;
  }

  function formatDue(t){
    if(!t.dueDate) return "Sin fecha";
    const dt = parseDateTime(t.dueDate, t.dueTime || "00:00");
    if(!dt) return "Sin fecha";
    const d = dt.toLocaleDateString("es-ES", { weekday:"short", day:"2-digit", month:"2-digit" });
    const hhmm = t.dueTime ? (" ¬∑ "+t.dueTime) : "";
    return d + hhmm;
  }

  function renderTasks(){
    const arr = filteredTasks();
    tasklist.innerHTML = "";
    empty.style.display = arr.length ? "none" : "block";

    for(const t of arr){
      const tags = (t.tags||[]).slice(0,6).map(x=>`<span class="tag">#${escapeHtml(x)}</span>`).join("");
      const due = `<span class="tag" title="Fecha">${escapeHtml(formatDue(t))}</span>`;
      const rem = t.reminder && t.reminder!=="none" ? `<span class="tag" title="Recordatorio">üîî ${escapeHtml(remLabel(t.reminder))}</span>` : "";
      const notes = t.notes ? `<div class="small" style="margin-top:6px; color:rgba(232,236,255,.75);">${escapeHtml(t.notes)}</div>` : "";

      const el = document.createElement("div");
      el.className = "task";
      el.innerHTML = `
        <div class="chk ${t.done ? "done":""}" title="Marcar hecha">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M20 6L9 17l-5-5" stroke="rgba(232,236,255,.95)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <p class="t-title ${t.done ? "done":""}">${escapeHtml(t.title)}</p>
          <div class="t-meta">
            ${prioBadge(t.prio)}
            ${due}
            ${rem}
            ${tags}
          </div>
          ${notes}
        </div>
        <div class="t-actions">
          <button class="iconbtn" title="Editar">‚úèÔ∏è</button>
          <button class="iconbtn" title="Eliminar">üóëÔ∏è</button>
        </div>
      `;
      // events
      el.querySelector(".chk").onclick = () => toggleDone(t.id);
      const [bEdit, bDel] = el.querySelectorAll(".iconbtn");
      bEdit.onclick = () => editTask(t.id);
      bDel.onclick = () => removeTask(t.id);

      tasklist.appendChild(el);
    }
  }

  // ----- Semana -----
  function weekDays(start){
    const days = [];
    for(let i=0;i<7;i++) days.push(addDays(start, i));
    return days;
  }

  function renderWeek(){
    const days = weekDays(state.weekStart);
    const arr = state.tasks.slice();

    weekEl.innerHTML = "";
    for(const d of days){
      const dayTasks = arr
        .filter(t => t.dueDate && isSameDay(parseDateTime(t.dueDate, t.dueTime||"00:00"), d))
        .sort((a,b)=>{
          const at = a.dueTime || "99:99";
          const bt = b.dueTime || "99:99";
          return at.localeCompare(bt);
        });

      const dayName = d.toLocaleDateString("es-ES", { weekday:"short" });
      const ddmm = d.toLocaleDateString("es-ES", { day:"2-digit", month:"2-digit" });
      const isToday = isSameDay(d, today0());

      const box = document.createElement("div");
      box.className = "day";
      box.innerHTML = `
        <h3>
          <span>${capitalize(dayName)} ${ddmm}${isToday ? " ¬∑ hoy" : ""}</span>
          <span>${dayTasks.length}</span>
        </h3>
        <div class="mini"></div>
      `;
      const mini = box.querySelector(".mini");

      if(dayTasks.length===0){
        const p = document.createElement("div");
        p.className = "small";
        p.textContent = "Sin tareas";
        mini.appendChild(p);
      } else {
        for(const t of dayTasks.slice(0,6)){
          const it = document.createElement("div");
          it.className = "mini-item";
          it.innerHTML = `
            <div>
              <b>${escapeHtml(t.title)}</b>
              <div class="due">${t.dueTime ? escapeHtml(t.dueTime) : "‚Äî"}</div>
            </div>
            <div style="opacity:.85">${t.done ? "‚úÖ" : "‚è≥"}</div>
          `;
          it.onclick = () => {
            state.filter = "all";
            q.value = t.title;
            render();
            showToast("Filtrado por tarea.");
          };
          mini.appendChild(it);
        }
        if(dayTasks.length>6){
          const more = document.createElement("div");
          more.className = "small";
          more.textContent = `+${dayTasks.length-6} m√°s`;
          mini.appendChild(more);
        }
      }

      weekEl.appendChild(box);
    }
  }

  // ----- Estad√≠sticas + racha -----
  function registerDoneDay(d){
    try{
      const key = ymd(d);
      const raw = localStorage.getItem(LS_DONE_DAYS);
      const set = raw ? new Set(JSON.parse(raw)) : new Set();
      set.add(key);
      // limita a ~400 d√≠as
      const arr = Array.from(set).sort().slice(-400);
      localStorage.setItem(LS_DONE_DAYS, JSON.stringify(arr));
    }catch(e){}
  }

  function calcStreak(){
    try{
      const raw = localStorage.getItem(LS_DONE_DAYS);
      const arr = raw ? JSON.parse(raw) : [];
      if(!arr.length) return 0;
      const set = new Set(arr);
      let streak = 0;
      let d = today0();
      // Cuenta hacia atr√°s mientras haya d√≠a marcado
      for(let i=0;i<365;i++){
        const key = ymd(d);
        if(set.has(key)){
          streak++;
          d = addDays(d, -1);
        } else break;
      }
      return streak;
    }catch(e){
      return 0;
    }
  }

  function renderStats(){
    const total = state.tasks.length || 1;
    const done = state.tasks.filter(t=>t.done).length;
    const open = state.tasks.filter(t=>!t.done).length;

    kDone.textContent = done;
    kOpen.textContent = open;

    const pctDone = Math.round((done/total)*100);
    const pctOpen = Math.round((open/total)*100);

    barDone.style.width = pctDone + "%";
    barOpen.style.width = pctOpen + "%";

    kStreak.textContent = calcStreak();
  }

  // ----- Recordatorios -----
  function remLabel(rem){
    if(rem==="at") return "a la hora";
    if(rem==="15") return "15 min";
    if(rem==="60") return "1 h";
    if(rem==="1440") return "1 d√≠a";
    return "‚Äî";
  }

  async function ensureNotifs(){
    if(!("Notification" in window)){
      showToast("Tu navegador no soporta notificaciones.");
      return false;
    }
    if(Notification.permission === "granted"){
      state.notifsEnabled = true;
      showToast("Notificaciones activadas.");
      return true;
    }
    if(Notification.permission === "denied"){
      showToast("Notificaciones bloqueadas en el navegador.");
      return false;
    }
    const perm = await Notification.requestPermission();
    state.notifsEnabled = (perm === "granted");
    showToast(state.notifsEnabled ? "Notificaciones activadas." : "Permiso no concedido.");
    return state.notifsEnabled;
  }

  function notify(title, body){
    if(state.notifsEnabled && "Notification" in window && Notification.permission==="granted"){
      try{
        new Notification(title, { body });
      }catch(e){
        alert(title + "\n\n" + body);
      }
    } else {
      // fallback suave
      showToast("üîî " + title);
      // y si est√° en primer plano, tambi√©n alert opcional (no lo hacemos para no molestar)
    }
  }

  function clearTimers(){
    for(const [,t] of state.timers){
      clearTimeout(t);
    }
    state.timers.clear();
  }

  function rescheduleAll(){
    clearTimers();
    const now = Date.now();

    for(const t of state.tasks){
      if(t.done) continue;
      if(!t.dueDate) continue;
      if(!t.reminder || t.reminder==="none") continue;

      const due = parseDateTime(t.dueDate, t.dueTime || "09:00");
      if(!due) continue;

      let when = new Date(due);
      if(t.reminder === "15") when = new Date(due.getTime() - 15*60*1000);
      if(t.reminder === "60") when = new Date(due.getTime() - 60*60*1000);
      if(t.reminder === "1440") when = new Date(due.getTime() - 24*60*60*1000);
      // "at" = due

      const ms = when.getTime() - now;
      if(ms <= 0) continue; // ya pas√≥

      // limita timeouts muy largos (navegadores pueden dormir)
      // Aun as√≠ lo ponemos: es un MVP.
      const tid = setTimeout(()=>{
        notify("StudyFlow ¬∑ Recordatorio", t.title + (t.dueDate ? (" ¬∑ " + formatDue(t)) : ""));
      }, ms);

      state.timers.set(t.id, tid);
    }
  }

  // ----- Export/Import -----
  function openModal(title, help, content, mode){
    mTitle.textContent = title;
    mHelp.textContent = help;
    io.value = content || "";
    modal.style.display = "flex";
    btnApply.style.display = (mode==="import") ? "inline-flex" : "none";
  }
  function closeModal(){ modal.style.display = "none"; }

  function doExport(){
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      tasks: state.tasks
    };
    openModal("Exportar (JSON)", "Copia este JSON para guardarlo o llevarlo a otro equipo.", JSON.stringify(payload, null, 2), "export");
  }
  function doImport(){
    openModal("Importar (JSON)", "Pega aqu√≠ un JSON exportado. Se sustituir√°n las tareas actuales.", "", "import");
  }
  function applyImport(){
    try{
      const parsed = JSON.parse(io.value);
      const tasks = parsed.tasks || parsed;
      if(!Array.isArray(tasks)) throw new Error("Formato no v√°lido");
      state.tasks = tasks.map(t => ({
        id: t.id || cryptoId(),
        title: String(t.title || "").trim(),
        dueDate: t.dueDate || "",
        dueTime: t.dueTime || "",
        prio: t.prio || "mid",
        tags: Array.isArray(t.tags) ? t.tags : parseTags(t.tags || ""),
        notes: t.notes || "",
        reminder: t.reminder || "none",
        done: !!t.done,
        createdAt: t.createdAt || Date.now(),
        doneAt: t.doneAt || null
      }));
      save();
      render();
      closeModal();
      showToast("Importaci√≥n completada.");
    }catch(e){
      showToast("Error al importar: revisa el JSON.");
    }
  }

  // ----- Utils -----
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function capitalize(s){
    s = String(s||"");
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  // ----- Render general -----
  function render(){
    // filtros seg
    segBtns.forEach(b => b.classList.toggle("active", b.dataset.filter===state.filter));
    renderTasks();
    renderWeek();
    renderStats();
  }

  // ----- Eventos -----
  btnAdd.onclick = addTask;

  segBtns.forEach(b => {
    b.onclick = () => {
      state.filter = b.dataset.filter;
      render();
    };
  });

  q.oninput = () => render();
  sortSel.onchange = () => render();

  btnThisWeek.onclick = () => { state.weekStart = startOfWeek(new Date()); renderWeek(); showToast("Semana actual."); };
  btnNextWeek.onclick = () => { state.weekStart = addDays(state.weekStart, 7); renderWeek(); showToast("Semana +7."); };

  btnReset.onclick = () => {
    if(!confirm("¬øReiniciar y borrar todas las tareas?")) return;
    state.tasks = [];
    save();
    render();
    showToast("Reiniciado.");
  };

  btnExport.onclick = doExport;
  btnImport.onclick = doImport;

  btnClose.onclick = closeModal;
  modal.addEventListener("click", (e)=> { if(e.target===modal) closeModal(); });

  btnCopy.onclick = async () => {
    try{
      await navigator.clipboard.writeText(io.value);
      showToast("Copiado al portapapeles.");
    }catch(e){
      showToast("No se pudo copiar (permiso).");
    }
  };

  btnApply.onclick = applyImport;

  btnNotifs.onclick = async () => {
    const ok = await ensureNotifs();
    if(ok){
      rescheduleAll();
      showToast("Recordatorios programados (si hay tareas con aviso).");
    }
  };

  // ----- Defaults (para probar) -----
  function seedIfEmpty(){
    if(state.tasks.length) return;
    const d = new Date();
    const d1 = addDays(d,0);
    const d2 = addDays(d,1);
    const d3 = addDays(d,2);

    state.tasks = [
      {
        id: cryptoId(),
        title:"Repasar Unidad 6 ¬∑ FIFO vs PMP (ejercicio)",
        dueDate: ymd(d1),
        dueTime: "19:00",
        prio:"high",
        tags:["mates","fag"],
        notes:"Hacer tabla y justificar m√©todo en precios crecientes.",
        reminder:"60",
        done:false, createdAt: Date.now()-600000, doneAt:null
      },
      {
        id: cryptoId(),
        title:"Preparar storyboard del servicio (6 vi√±etas)",
        dueDate: ymd(d2),
        dueTime: "18:30",
        prio:"mid",
        tags:["prototipo","studyflow"],
        notes:"Qu√© prueba, qu√© cambiar√≠a tras feedback.",
        reminder:"15",
        done:false, createdAt: Date.now()-520000, doneAt:null
      },
      {
        id: cryptoId(),
        title:"Enviar borrador del plan semanal al equipo",
        dueDate: ymd(d3),
        dueTime: "",
        prio:"low",
        tags:["organizaci√≥n"],
        notes:"",
        reminder:"none",
        done:false, createdAt: Date.now()-420000, doneAt:null
      }
    ];
    save();
  }

  // ----- Init -----
  load();
  seedIfEmpty();
  state.weekStart = startOfWeek(new Date());
  render();
  rescheduleAll();
})();
</script>
</body>
</html>
